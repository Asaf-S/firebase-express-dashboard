<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/superagent"></script>
</head>

<body>
  <div style="display: flex; " >
    <h1 style="margin-right: 30px;">Users</h1>
    <div style="display: flex; align-items: center;">
      <button onclick="createNewUser()">Create new user</button>
    </div>
    <div style="width:100px"></div>
    <h1 style="align-self: flex-end;" id="project_id">Loading...</h1>
  </div>
  <div id="main">Loading...</div>
  <script>

    window.shouldResetButtonBeDisabled = true;
    const mainElement = document.getElementById('main');
    const projectIdElement = document.getElementById('project_id');


    function postToServer(url, body) {
      const headers = {
        'Content-Type': 'application/json'
      };

      return superagent
        .post(url)
        .set(headers)
        .send(JSON.stringify(body));del
    }

    function refreshUserList() {
      mainElement.innerHTML=`Loading...`;
      return superagent
        .get('users')
        .then(function (res) {
          const htmlTable_prefix = `
          <table border='1' style='width:100%;border-width:1px;border-color:black;'>
            <tr style='background: lightgray'>
              <th>UID</th>
              <th>Email</th>
              <th>Verified</th>
              <th>Disabled</th>
              <th>Creation Time</th>
              <th>Last Sign In</th>
              <th>Providers</th>
              <th>Claims</th>
              <th>Actions</th>
            </tr>
          `;
          const htmlTable_data = res.body.map((user) => {
            const lastSignInTime_Date = new Date(user.metadata.lastSignInTime);
            const lastSignInTime_String = lastSignInTime_Date.getTime() ? lastSignInTime_Date.toISOString().replace('T', ' ').replace('.000Z', '') : "Never";

            return `
            <tr>
              <td>${user.uid}</td>
              <td>${user.email}</td>
              <td>${user.emailVerified ? 'V' : 'X'}</td>
              <td>${user.disabled ? 'V' : ''}</td>
              <td>${new Date(user.metadata.creationTime).toISOString().replace('T', ' ').replace('.000Z', '')}</td>
              <td>${lastSignInTime_String}</td>
              <td>${user.providerData.map((provider, i) => {
                var prefix = (i == 0) ? '' : '\n';
                if (provider.providerId === "password") {
                  return prefix + provider.providerId + '\n';
                } else {
                  return prefix + JSON.stringify(provider, null, 2) + '\n';
                }
              })}</td>
              <td style="text-align: center;">
                <img
                  onclick="showClaims('${user.uid}')"
                  style="cursor: pointer; width: 15px; height: 15px"
                  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAIAAADajyQQAAAACXBIWXMAABYlAAAWJQFJUiTwAAAEIUlEQVRo3u1bv267MBB2UTf6AEhVxc6A2JDaDhncrUNXHqBbxTvwAF1C905eMrUDUzNkIJXYIgZWhKpIUWYzgcRvyE9typk/iSEBmttKUnKf77vPZ/t8lmUZatTiOF4sFlEUeZ4XBMF0OmV+DWOsKIqu67Isa5omimKzbqCsIQvD0LZtVVX3c0NVVdu2wzBsyh9eYJRSHjxFCCmlRwNGKbUsC7VmlmXxwNsHWJIkrULKwUuS5BDAHMeRJAkd0CRJchxnVz/P6qtiHMcPDw9FKgdTZTQabUTv8vIy9+lyudzI5mw2832/zgsxxm9vbzuIZ80B8H2/TqBM03Rdd6fcoJS6rmuaZp3Q+b7fJBUdx6n8SUIIp5RRSgkhlcNXk5bVwCp1ghCyX34XKRMhpFJReIGVo+JUZJ65pBIb2g+Vqqrr9Tpr2dbrdcnUX44N7ZFXGOMGuVfJTIzxHvmGijSQh9+NWwl3inQSMfldJE2u62ZHMtd1iwSZmecMYEWhPyKqcmwY42pgRal1FAbW5yRMNpTLVCYJmUOy68xrGIZhGPxLEiahJEnK6RmqHA9VVXk0MAxD+E6eBWWSJMw5IMcptD2uzChzzlfMAVZVlXN+Y7q6zQVUHi7+1CqSac6ZsNJbVB6uBpbo7QCrdFjY/P36+sqsbvk3j4qoeH5+zvNaURSZtfIPkA0+mI5QZzoiHuUa/p29qOi3CSENluqEEMuyTNPkX7ZtGzNom1FDWZbZtt1Gdh3AmJlm2/Z/YJCHpmlmPTG4p7Bh4xml9OLiApaFNzc3jewxvby8fH5+5h5eX18/PT018v75fH57ewvphpiVZYM8NAwDvt8wjFbZ6LquEEURDGXzRwStmSiKMJWiKBI8z8s9HY1GqFcGHfY8TwiCIPdU1/V+AYMOB0EgwJ1dWZb7BQw6PJ1OBfg9uCPdcWM6LKCB2gnYCdgJ2MGBLZfLfmFgOizAFS4ssjpu0GGMsaAoCqxH+gUMOqwoigDrkdls1i9g0GFd1wVYj/i+H8dxX1DFcQzPhmRZFjRNg99eLBZ9AcZ0VdM0gbmemUwmfQEGXd2sJwWE0OPjY+6z8XjcCzbGcTwej3MPN3AEhND9/T38n/f39+4DYzr5H07bG6bt7XmUb5gK2+HbttVq1fFMm0wmq9WKycOfiLV3KNFSxOoeSoiiyDyYeX5+7ma4mI5ZlvWzv9b2wV8bEatz8PdT3RcFDWOcpml3YpWmKfNo6le4EPrVr5im6dXVFcxIjPHHx8d+fsznc1h9y7K89xb63d0d3FmTJOnr6+vXmdufaIcYcgPLkFuOBtskNuS2viE3Yg65dXbIzc6V+fYtTf1rT//WyX5dKPjzV0C2admLSzuna1a7KzI/pENfjMvBG9pVRti+16nLpzuoYn3x7MJ14X9TxDxp9ACuUgAAAABJRU5ErkJggg==">
              </td>
              <td>
                ${user.emailVerified ? '' : `<button onclick="alert('${user.uid}')">Send verification email</button>`}
                <button onclick="alert('Under development ${user.uid}')">Set claims</button>
                <button onclick="alert('Under development ${user.uid}')">Disable</button>
                <button class="dependantOnWebAPI" onclick="reset_password('${user.email}')">Reset password</button>
                <button onclick="deleteUser('${user.uid}')">Delete</button>
              </td>
            </tr>`;
          }).join('');
          const htmlTable_suffix = `</table>`;

          mainElement.innerHTML = htmlTable_prefix + htmlTable_data + htmlTable_suffix;

          const buttonsDependantOnWebAPI = document.getElementsByClassName('dependantOnWebAPI');
          for (var button of buttonsDependantOnWebAPI) {
            button.disabled = window.shouldResetButtonBeDisabled;
            button.title = window.shouldResetButtonBeDisabled ? "The webAPI field was not provided to 'firebase-express-dashbard'." : "";
          }
        }).catch((err) => {
          console.error(`ERROR: ${err.stack}`);
        });
    }

    function createNewUser() {
      const email = prompt("Please enter an email address:");
      if (email) {
        postToServer('users/new', { email }).then(res => {
          if(res.body.isSuccessful) {
            console.log(`Email: ${email}\nUser ID: ${res.body.userID}`);
            alert('New user successfully created!');
          } else {
            alert(`Error!\nReason: ${res.body.reason}`);
          }
          refreshUserList();
        });
      } else {
        console.error(`Email=${email} (${typeof(email)})`);
      }
    }

    function reset_password(email) {
      if(confirm("Send a reset-password email to the user's email?")) {

        postToServer('resetpassword', { email }).then(res => {
          if(res && res.body && res.body.isSuccessful) {
            alert(`Password-reset email was sent!`);
          } else {
            console.error(`Error!\nReason: ${res.body.reason}`);
            alert(`Failed to send password-reset email!`);
          }
        });
      }
    }

    function deleteUser(uid) {
      if(uid && confirm("Are you sure you want to DELETE this user?")) {

        return superagent
          .del(`users/${uid}`)
          // .set(headers)
          // .send(JSON.stringify(body))
          .then(res => {
            if(res.body.isSuccessful) {
              console.log(`Deleted user ID: ${res.body.userID}`);
              alert('The user was successfully deleted!');
            } else {
              alert(`Error!\nReason: ${res.body.reason}`);
            }
            refreshUserList();
          });
      }
    }

    function showClaims(uid) {
      return superagent
        .get(`users/${uid}/claims`)
        .then(function (res) {
          if(res.body.isSuccessful) {
            const claims = res.body.claims;
            if(claims) {
              alert(JSON.stringify(claims, null, 2));
            } else {
              alert(`The user has no claims!`);
            }
          } else {
            alert(`Error getting the user's claims!`);
          }
        });
    }

    function updateClaims(uid) {

      postToServer(`users/${uid}`, { admin: 1 }).then(res => {
        if(res && res.body && res.body.isSuccessful) {
          console.log(`Claims were updated!`);
        } else {
          const err1 = `Failed to update claims!`;
          console.error(err1);
          alert(err1);
        }
      });
    }

    function getProjectDetails() {

      projectIdElement.innerHTML=`Loading...`;
      return superagent
        .get('projectDetails')
        .then(function (res) {
          if(res.body.isSuccessful && res.body.projectDetails) {
            projectIdElement.innerHTML=res.body.projectDetails.projectId;
            window.shouldResetButtonBeDisabled = res.body.projectDetails.shouldResetButtonBeDisabled;
          } else {
            console.error(`Error!\nReason: ${res.body.projectDetails}`);
            projectIdElement.innerHTML="Project ID: Unknown";
          }
        })
        .catch(e=>{
          console.error(`Error!\nReason: ${e.stack}`);
          projectIdElement.innerHTML="Project ID: Error";
        });
    }

    getProjectDetails();
    refreshUserList();
  </script>
</body>

</html>