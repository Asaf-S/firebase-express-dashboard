<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/superagent"></script>
</head>

<body>
  <div style="display: flex; " >
    <h1 style="margin-right: 30px;">Users</h1>
    <div style="display: flex; align-items: center;">
      <button onclick="createNewUser()">Create new user</button>
    </div>
  </div>
  <div id="main">Loading...</div>
  <script>

    const mainElement = document.getElementById('main');

    function postToServer(url, body) {
      const headers = {
        'Content-Type': 'application/json'
      };

      return superagent
        .post(url)
        .set(headers)
        .send(JSON.stringify(body));del
    }

    function refreshUserList() {
      mainElement.innerHTML=`Loading...`;
      return superagent
        .get('users')
        .then(function (res) {
          const htmlTable_prefix = `<table border='1' style='width:100%;border-width:1px;border-color:black;'>
          <tr style='background: lightgray'>
            <th>UID</th>
            <th>Email</th>
            <th>Verified</th>
            <th>Disabled</th>
            <th>Creation Time</th>
            <th>Last Sign In</th>
            <th>Providers</th>
            <th>Actions</th>
          </tr>
        `;
          const htmlTable_suffix = `</table>`;
          const htmlTable_data = res.body.map((user) => {
            const lastSignInTime_Date = new Date(user.metadata.lastSignInTime);
            const lastSignInTime_String = lastSignInTime_Date.getTime() ? lastSignInTime_Date.toISOString().replace('T', ' ').replace('.000Z', '') : "Never";

            return `<tr>
              <td>${user.uid}</td>
              <td>${user.email}</td>
              <td>${user.emailVerified ? 'V' : 'X'}</td>
              <td>${user.disabled ? 'V' : ''}</td>
              <td>${new Date(user.metadata.creationTime).toISOString().replace('T', ' ').replace('.000Z', '')}</td>
              <td>${lastSignInTime_String}</td>
              <td>${user.providerData.map((provider, i) => {
              var prefix = (i == 0) ? '' : '\n';
              if (provider.providerId === "password") {
                return prefix + provider.providerId + '\n';
              } else {
                return prefix + JSON.stringify(provider, null, 2) + '\n';
              }
            })}</td>
              <td>
                ${user.emailVerified ? '' : `<button onclick="alert('${user.uid}')">Send verification email</button>`}
                <button onclick="alert('${user.uid}')">Disable</button>
                <button onclick="reset_password('${user.email}')">Reset password</button>
                <button onclick="deleteUser('${user.uid}')">Delete</button>
              </td>
            </tr>`;
          }).join('');

          mainElement.innerHTML = htmlTable_prefix + htmlTable_data + htmlTable_suffix;
        }).catch((err) => {
          console.error(`ERROR: ${err.stack}`);
        });
    }

    function createNewUser() {
      const email = prompt("Please enter an email address:");
      if (email) {
        postToServer('users/new', { email }).then(res => {
          if(res.body.isSuccessful) {
            console.log(`Email: ${email}\nUser ID: ${res.body.userID}`);
            alert('New user successfully created!');
          } else {
            alert(`Error!\nReason: ${res.body.reason}`);
          }
          refreshUserList();
        });
      } else {
        console.log(`Email=${email} (${typeof(email)})`);
      }
    }

    function reset_password(email) {
      if(confirm("Send a reset-password email to the user's email?")) {

        postToServer('resetpassword', { email }).then(res => {
          if(res && res.body && res.body.isSuccessful) {
            alert(`Password-reset email was sent!`);
          } else {
            alert(`Failed to send password-reset email!`);
          }
        });
      }
    }

    function deleteUser(uid) {
      if(uid && confirm("Are you sure you want to DELETE this user?")) {

        return superagent
          .del(`users/${uid}`)
          // .set(headers)
          // .send(JSON.stringify(body))
          .then(res => {
            if(res.body.isSuccessful) {
              console.log(`Deleted user ID: ${res.body.userID}`);
              alert('The user was successfully deleted!');
            } else {
              alert(`Error!\nReason: ${res.body.reason}`);
            }
            refreshUserList();
          });
      }
    }

    refreshUserList();
  </script>
</body>

</html>